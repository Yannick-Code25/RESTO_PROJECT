<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panier - Mon Restaurant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary-color: #ff6b6b;
        --secondary-color: #ff8e8e;
        --dark-color: #333;
        --light-color: #f8f9fa;
        --success-color: #40c057;
        --error-color: #ff6b6b;
        --warning-color: #fcc419;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }
      
      * {
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #fff9f9;
        color: var(--dark-color);
        padding-bottom: 80px;
      }
      
      .header {
        background-color: white;
        padding: 15px 20px;
        box-shadow: var(--shadow);
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .header h1 {
        margin: 0;
        font-size: 1.8rem;
        color: var(--primary-color);
        font-weight: 600;
      }
      
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      
      .cart-items {
        background-color: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 20px;
        margin-bottom: 25px;
        transition: var(--transition);
      }
      
      .cart-items:hover {
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      }
      
      .cart-item {
        display: grid;
        grid-template-columns: 80px 1fr auto;
        gap: 15px;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
        transition: var(--transition);
      }
      
      .cart-item:hover {
        transform: translateX(5px);
      }
      
      .cart-item:last-child {
        border-bottom: none;
      }
      
      .item-image {
        width: 80px;
        height: 80px;
        border-radius: 10px;
        object-fit: cover;
        box-shadow: var(--shadow);
      }
      
      .item-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      
      .item-name {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 1.1rem;
        color: var(--dark-color);
      }
      
      .item-price {
        color: var(--primary-color);
        font-weight: bold;
        font-size: 1rem;
      }
      
      .item-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
      }
      
      .item-quantity {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .quantity-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid #ddd;
        background-color: white;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
      }
      
      .quantity-btn:hover {
        background-color: #f8f8f8;
        transform: scale(1.1);
      }
      
      .quantity-btn.minus:hover {
        color: var(--error-color);
        border-color: var(--error-color);
      }
      
      .quantity-btn.plus:hover {
        color: var(--success-color);
        border-color: var(--success-color);
      }
      
      .remove-btn {
        background-color: transparent;
        color: #999;
        border: none;
        border-radius: 5px;
        padding: 8px;
        cursor: pointer;
        transition: var(--transition);
      }
      
      .remove-btn:hover {
        color: var(--error-color);
        transform: rotate(15deg);
      }
      
      .payment-section {
        background-color: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        margin-bottom: 25px;
        transition: var(--transition);
      }
      
      .payment-section:hover {
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      }
      
      .payment-section h3 {
        margin-top: 0;
        color: var(--dark-color);
        font-weight: 600;
      }
      
      .payment-methods {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      
      .payment-method {
        border: 2px solid #eee;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
      }
      
      .payment-method:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }
      
      .payment-method.selected {
        border-color: var(--primary-color);
        background-color: rgba(255, 107, 107, 0.05);
        position: relative;
      }
      
      .payment-method.selected::after {
        content: "✓";
        position: absolute;
        top: -10px;
        right: -10px;
        background-color: var(--primary-color);
        color: white;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
      }
      
      .payment-method i {
        font-size: 2rem;
        margin-bottom: 10px;
        color: var(--primary-color);
      }
      
      .payment-method div {
        font-weight: 500;
      }
      
      .total-section {
        background-color: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
      }
      
      .total-section:hover {
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      }
      
      .total-label {
        font-size: 1rem;
        color: #666;
      }
      
      .total-amount {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary-color);
      }
      
      .checkout-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 15px 30px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .checkout-btn:hover {
        background-color: var(--secondary-color);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
      }
      
      .checkout-btn:active {
        transform: translateY(0);
      }
      
      .empty-cart {
        text-align: center;
        padding: 40px 0;
        color: #999;
      }
      
      .empty-cart i {
        font-size: 3rem;
        margin-bottom: 20px;
        color: #ddd;
      }
      
      .empty-cart p {
        font-size: 1.1rem;
        margin-bottom: 20px;
      }
      
      .empty-cart a {
        display: inline-block;
        padding: 10px 20px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: var(--transition);
      }
      
      .empty-cart a:hover {
        background-color: var(--secondary-color);
        transform: translateY(-2px);
      }
      
      .bottom-nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: #fff;
        display: flex;
        justify-content: space-around;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding: 12px 0;
        z-index: 1000;
      }
      
      .bottom-nav a {
        color: #888;
        text-align: center;
        text-decoration: none;
        font-size: 0.8rem;
        position: relative;
        transition: var(--transition);
        flex: 1;
      }
      
      .bottom-nav a.active {
        color: var(--primary-color);
      }
      
      .bottom-nav i {
        font-size: 1.4rem;
        display: block;
        margin-bottom: 5px;
        transition: var(--transition);
      }
      
      .bottom-nav a.active i {
        transform: translateY(-5px);
      }
      
      .status-indicator {
        width: 10px;
        height: 10px;
        background: var(--success-color);
        border-radius: 50%;
        position: absolute;
        top: 2px;
        right: 22px;
        border: 2px solid white;
      }
      
      .cart-badge {
        position: absolute;
        top: -5px;
        right: 15px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        font-size: 0.7rem;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
      }
      
      #message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--success-color);
        color: white;
        padding: 12px 25px;
        border-radius: 50px;
        display: none;
        z-index: 9999;
        box-shadow: var(--shadow);
        font-weight: 500;
        animation: fadeIn 0.3s ease;
      }
      
      #message.error {
        background: var(--error-color);
      }
      
      #message.warning {
        background: var(--warning-color);
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translate(-50%, -20px); }
        to { opacity: 1; transform: translate(-50%, 0); }
      }
      
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }
        
        .payment-methods {
          grid-template-columns: 1fr;
        }
        
        .total-section {
          flex-direction: column;
          text-align: center;
          gap: 15px;
        }
        
        .checkout-btn {
          width: 100%;
          justify-content: center;
        }
      }
      
      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.5rem;
        }
        
        .cart-item {
          grid-template-columns: 60px 1fr;
          grid-template-rows: auto auto;
        }

        .item-info{
          align-items: center;
        }
        
        .item-controls {
          grid-column: 2;
          grid-row: 2;
          flex-direction: row;
          justify-content: space-between;
          width: 100%;
        }
        
        .remove-btn {
          order: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Votre Panier</h1>
    </div>

    <div id="message"></div>

    <div class="container">
      <div class="cart-items" id="cart-items-container">
        <!-- Les articles du panier seront ajoutés ici dynamiquement -->
      </div>

      <div class="payment-section">
        <h3>Méthode de paiement</h3>
        <div class="payment-methods">
          <div class="payment-method" data-method="cash">
            <i class="fas fa-money-bill-wave"></i>
            <div>Paiement à la livraison</div>
          </div>
          <div class="payment-method" data-method="card">
            <i class="fas fa-credit-card"></i>
            <div>Carte bancaire</div>
          </div>
          <div class="payment-method" data-method="online">
            <i class="fab fa-paypal"></i>
            <div>PayPal</div>
          </div>
        </div>
      </div>

      <div class="total-section">
        <div>
          <div class="total-label">Total</div>
          <div class="total-amount" id="total-amount">0,00 €</div>
        </div>
        <button class="checkout-btn" id="checkout-btn">
          <i class="fas fa-check-circle"></i> Valider
        </button>
      </div>
    </div>

    <nav class="bottom-nav">
      <a href="menu.html"><i class="fas fa-utensils"></i>Menu</a>
      <a href="profil.html">
        <i class="fas fa-user"></i>Profil
        <span class="status-indicator" title="Connecté"></span>
      </a>
      <a href="panier.html" class="active">
        <i class="fas fa-shopping-cart"></i>Panier
        <span class="cart-badge" id="cart-count">0</span>
      </a>
    </nav>

    <script>
      // Données des produits avec images
      const productsData = {
        "1": {
          "image": "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80",
          "name": "Pizza Margherita",
          "price": 8.9
        },
        "2": {
          "image": "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80",
          "name": "Burger Gourmet",
          "price": 12.5
        },
        "3": {
          "image": "https://images.unsplash.com/photo-1546793665-c74683f339c1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80",
          "name": "Salade César",
          "price": 9.5
        },
        "4": {
          "image": "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80",
          "name": "Pâtes Carbonara",
          "price": 11.9
        },
        "5": {
          "image": "https://images.unsplash.com/photo-1559847844-5315695dadae?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80",
          "name": "Dessert du Chef",
          "price": 7.5
        }
      };

      document.addEventListener("DOMContentLoaded", function () {
        // Récupération des infos utilisateur
        const token = localStorage.getItem("token");
        const userId = localStorage.getItem("userId");
        const email = localStorage.getItem("email");

        // Initialisation
        let panier = JSON.parse(localStorage.getItem("panier")) || [];
        let selectedPaymentMethod = null;

        // Filtrer le panier pour l'utilisateur courant
        let userCart = panier.filter((item) => item.userId === userId);

        // Afficher le panier
        displayCart();
        updateCartCount();
        setupPaymentMethods();
        setupCheckoutButton();

        // Fonction pour afficher le panier
        function displayCart() {
          const container = document.getElementById("cart-items-container");

          if (userCart.length === 0) {
            container.innerHTML = `
              <div class="empty-cart">
                <i class="fas fa-shopping-cart"></i>
                <p>Votre panier est vide</p>
                <a href="menu.html">Voir le menu</a>
              </div>
            `;
            document.getElementById("total-amount").textContent = "0,00 €";
            document.getElementById("checkout-btn").style.display = "none";
            return;
          } else {
            document.getElementById("checkout-btn").style.display = "flex";
          }

          container.innerHTML = "";
          let total = 0;

          userCart.forEach((item, index) => {
            const product = productsData[item.produit_id];
            const itemTotal = item.prix_unitaire * item.quantite;
            total += itemTotal;

            const itemElement = document.createElement("div");
            itemElement.className = "cart-item";
            itemElement.innerHTML = `
              <img src="${product.image}" alt="${product.name}" class="item-image">
              <div class="item-info">
                <div class="item-name">${product.name}</div>
                <div class="item-price">${item.prix_unitaire.toFixed(2)} €</div>
              </div>
              <div class="item-controls">
                <div class="item-quantity">
                  <button class="quantity-btn minus" data-index="${index}" title="Diminuer">
                    <i class="fas fa-minus"></i>
                  </button>
                  <span>${item.quantite}</span>
                  <button class="quantity-btn plus" data-index="${index}" title="Augmenter">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                <button class="remove-btn" data-index="${index}" title="Supprimer">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            `;

            container.appendChild(itemElement);
          });

          // Mettre à jour le total
          document.getElementById("total-amount").textContent = `${total.toFixed(2)} €`;

          // Ajouter les événements
          document.querySelectorAll(".quantity-btn.minus").forEach((btn) => {
            btn.addEventListener("click", decreaseQuantity);
          });

          document.querySelectorAll(".quantity-btn.plus").forEach((btn) => {
            btn.addEventListener("click", increaseQuantity);
          });

          document.querySelectorAll(".remove-btn").forEach((btn) => {
            btn.addEventListener("click", removeItem);
          });
        }

        // Fonctions pour modifier les quantités
        function decreaseQuantity(e) {
          const index = e.currentTarget.getAttribute("data-index");
          if (userCart[index].quantite > 1) {
            userCart[index].quantite--;
            showMessage("Quantité diminuée");
          } else {
            // Supprimer l'article du panier si la quantité est 1
            const itemName = userCart[index]?.nom;
            userCart.splice(index, 1);
            showMessage(`${itemName} retiré du panier`);
          }
          saveCart();
          displayCart();
        }

        function increaseQuantity(e) {
          const index = e.currentTarget.getAttribute("data-index");
          userCart[index].quantite++;
          saveCart();
          displayCart();
          showMessage("Quantité augmentée");
        }

        function removeItem(e) {
          const index = e.currentTarget.getAttribute("data-index");
          const itemName = userCart[index]?.nom;
          if (!itemName) return; // Sécurité : si undefined

          userCart.splice(index, 1);
          saveCart();
          displayCart();
          showMessage(`${itemName} retiré du panier`);
        }

        // Fonction pour sauvegarder le panier
        function saveCart() {
          // Mettre à jour le panier global
          panier = panier.filter((item) => item.userId !== userId); // Retirer les anciens articles
          panier = panier.concat(userCart); // Ajouter les nouveaux
          localStorage.setItem("panier", JSON.stringify(panier));
          updateCartCount();
        }

        // Fonction pour mettre à jour le compteur du panier
        function updateCartCount() {
          const count = userCart.reduce((total, item) => total + item.quantite, 0);
          document.getElementById("cart-count").textContent = count;

          // Mettre à jour aussi le badge dans le menu.html
          if (window.parent) {
            const parentCartCount = window.parent.document.getElementById("cart-count");
            if (parentCartCount) {
              parentCartCount.textContent = count;
            }
          }
        }

        // Configuration des méthodes de paiement
        function setupPaymentMethods() {
          document.querySelectorAll(".payment-method").forEach((method) => {
            method.addEventListener("click", function () {
              document.querySelectorAll(".payment-method").forEach((m) => {
                m.classList.remove("selected");
              });
              this.classList.add("selected");
              selectedPaymentMethod = this.getAttribute("data-method");
            });
          });
        }

        // Configuration du bouton de validation
        function setupCheckoutButton() {
          document.getElementById("checkout-btn").addEventListener("click", async function () {
            if (userCart.length === 0) {
              showMessage("Votre panier est vide", "error");
              return;
            }

            if (!selectedPaymentMethod) {
              showMessage("Veuillez choisir une méthode de paiement", "error");
              return;
            }

            // Animation du bouton
            const btn = this;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
            btn.disabled = true;

            // Préparer la commande
            const commande = {
              userId,
              email,
              articles: userCart.map(item => ({
                ...item,
                image: productsData[item.produit_id].image
              })),
              total: calculateTotal(),
              paymentMethod: selectedPaymentMethod,
              date: new Date().toISOString(),
              status: "en attente",
            };

            // Envoi de la commande au back-end
            try {
              const response = await fetch("http://localhost:3000/order", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(commande),
              });

              const data = await response.json();

              if (response.ok) {
                // Réinitialiser le panier local
                panier = panier.filter((item) => item.userId !== userId);
                userCart = [];
                saveCart();
                displayCart();
                updateCartCount();

                showMessage("Commande validée avec succès! ");
                
              } else {
                showMessage(data.message || "Erreur lors de la commande", "error");
              }
            } catch (err) {
              console.error("Erreur de communication avec le serveur", err);
              showMessage("Une erreur est survenue. Veuillez réessayer.", "error");
            } finally {
              btn.innerHTML = '<i class="fas fa-check-circle"></i> Valider';
              btn.disabled = false;
            }
          });
        }

        // Calculer le total
        function calculateTotal() {
          return userCart.reduce(
            (total, item) => total + item.prix_unitaire * item.quantite,
            0
          );
        }

        // Fonction pour afficher un message temporaire
        function showMessage(message, type = "success") {
          const msgBox = document.getElementById("message");
          msgBox.textContent = message;
          msgBox.className = "";
          msgBox.classList.add(type);
          msgBox.style.display = "block";
          
          setTimeout(() => {
            msgBox.style.opacity = "1";
          }, 10);
          
          setTimeout(() => {
            msgBox.style.opacity = "0";
            setTimeout(() => {
              msgBox.style.display = "none";
            }, 300);
          }, 3000);
        }
      });
    </script>
  </body>
</html>